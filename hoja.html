<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <title>Certificado</title>


</head>


<body style="margin: 0%;
padding: 0%;
background: rgb(9, 9, 121);
background: linear-gradient(313deg,
        rgba(9, 9, 121, 1) 34%,
        rgba(42, 250, 209, 1) 100%);">
    <div class="margen">
        <meta charset="UTF-8" />

        <style>
            #featuresListContainer {

                display: flexbox;
                width: 100%;
                text-align: center;

            }

            .box {
                display: inline-block;
                height: 40px;
                width: 223px;
                background-color: #dadada;
                margin: 1px;


                text-align: left;
                padding: 2px;
                line-height: 25px;


            }

            .container {
                width: 18cm;
                border: 3px, solid, rgb(0, 255, 55);
                margin: auto;
                margin-top: 20px;
                margin-bottom: 20px;
                padding: 20px;
                border-radius: 15px;
                /* Bordes redondeados */
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
                /* Sombra elegante */
                border: 1px solid #ddd;
                /* Borde fino para definición */
                background-color: #fff;
                /* Fondo blanco para contraste */
            }

            .fixed-buttons {
                position: fixed;
                top: 80px;
                right: 80px;
                display: flex;
                flex-direction: column;
                gap: 10px;
                z-index: 1000;
                /* Asegura que los botones estén al frente */
                width: 200px;
                /* Ancho fijo para ambos botones */
            }

            .fixed-buttons button {
                width: 100%;
                /* Hace que ambos botones ocupen el ancho completo del contenedor */
            }

            .logo {
                text-align: center;
            }

            .folio p {
                margin-top: 3px;
                text-align: left;
            }

            .contenido {
                width: 100%;
                margin-top: 25px;
                text-align: justify;
            }

            .QR {
                text-align: center;
            }

            .firmas {
                width: 80%;
                display: flex;
                margin: auto;
                margin-top: 20px;
                margin-bottom: 40px;
                justify-content: space-between;
            }

            .conf .form-check-input {
                transform: scale(1.5);
                /* Ajusta el valor para cambiar el tamaño */
                margin-right: 5px;
                color: red;
            }

            @media print {
                .fixed-buttons {
                    display: none;
                }

            }

            .fa-map-marker-alt {
                color: rgb(2, 145, 2);
            }

            thead {
                width: 90%;
                background: black;
                color: white;
            }

            p {
                width: 90%;
                margin: auto;
            }
        </style>
        <div class="container">

            </head>
            <div class="folio ">
                <p>Folio:<b> 00<spam id="folio"></spam>

                    </b></p>
            </div>
            <div class="logo ">
                <!-- <img src="./asset/Captura.JPG" alt="" /> -->
                <img src="./asset/Captura.JPG" alt="no img">
                <h1>CERTIFICADO</h1>
            </div>
            <div class="contenido">
                <p style="text-align: center">
                    Servicio de Implementación Tecnológica de la Información y Comunicación
                </p>
                <p>
                    Con fecha <b id="date">01/01/2023</b>, la empresa proveedora de
                    productos y servicios <b>WIT SPA</b> <b>RUT 77.122.368-K</b> certifica
                    que el vehículo patente <b id="patente">“RFKK-86”</b> perteneciente a
                    la empresa <b id="razon">TRANSPORTES TANDEM</b> RUT <b id="rut">99.593.350-K</b>, consta
                    de un equipamiento con la siguiente identificación:
                </p>

                <h4 style="width: 90%;margin: auto;">Tabla de Productos/Servicios</h4>

                <table class="table table-bordered " style="width: 90%;margin: auto;margin-bottom: 10px;">
                    <thead>
                        <tr>
                            <th scope="col">GPS</th>
                            <th scope="col">IMEI</th>
                            <th scope="col">No Cert-QA</th>
                            <th scope="col">Última Georreferencia</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>MasGPS</td>
                            <td id="imei">31G1812561067</td>
                            <td id="verify">Insertar número de certificación aquí</td>
                            <td><i class="fas fa-map-marker-alt"></i><a href="" id="lpf">link </a></td>
                        </tr>
                        <!-- Puedes agregar más filas según sea necesario -->
                    </tbody>
                </table>




            </div>
            <div id="contenido-tabla"></div>


            <div class="texto">
                <p>
                    Equipo electrónico homologado y certificado bajo las normas de uso para equipos electrónicos y de
                    telecomunicaciones FCC.
                </p>
                <p>
                    Los dispositivos instalados en este
                    vehículo están conectados a un servicio de comunicaciones, plataformas de monitoreo,
                    control, mesa de ayuda, estadística y administración.
                </p>
                <p>
                    El presente certificado se emite a solicitud de la parte interesada y expira el
                    <b id="fechaVencimiento">31/12/2024</b>.
                </p>
            </div>
            <div class="QR" style="    display: flex;
                margin-top: 30px;
                justify-content: center;">
                <div id="qrCode" style="margin: auto;"></div>
            </div>
            <div class="firmas">
                <img src="./asset/euro.JPG" alt="" style="left: 0%;" />
                <img src="./asset/isra.JPG" alt="" style="right: 0%;" />
            </div>

            <div class="footer">
                <p>
                    <b>WIT</b> – Manuel Obispo Umaña #633, Estación Central, Santiago, Chile /
                    Contactos: + 56 9 9073 7619 / soporte@wit.la
                </p>
            </div>
        </div>
    </div>
    </div>
    <div class="fixed-buttons">
        <button onclick="window.print()" class="btn btn-primary mr-2">Imprimir</button>
        <button onclick="descargarPDF()" class="btn btn-success">Descargar PDF</button>
        <button onclick="abrirModalCorreo()" class="btn btn-secondary">Enviar por correo</button>
    </div>

    <!-- Modal para ingresar el correo -->
    <div class="modal fade" id="modalCorreo" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Enviar Correo</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="email" class="form-control" id="email" placeholder="Ingrese el correo electrónico">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="btnEnviarCorreo">Enviar</button>
                </div>
            </div>
        </div>
    </div>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script>
        $(document).ready(function () {
            const datosGuardados = localStorage.getItem('vehiculoDatos');
            const datosVehiculo = JSON.parse(datosGuardados);
            var verify = generarClaveAleatoria(10);
            const codigo = verify;
            const patente = datosVehiculo.patente;
            const fechaHoraActual = new Date().toISOString();

            const datos = {
                patente: patente,
                codigo: codigo,
                fechaHora: fechaHoraActual
            };
            $("#contenido-tabla").load("tabla.html");
            axios.post('https://masgps-bi.wit.la/certificado-wit/server/escribirFolio.php', datos)
                .then(response => {
                    console.log('Datos enviados correctamente:', response.data);
                    const folio = response.data.id;
                    $("#folio").text(folio);

                    localStorage.setItem(
                        "folio",
                        JSON.stringify(folio)
                    );
                });

            verify = verify + '/' + patente;
            console.log(verify);
            // Función para generar el código QR
            function generarQR(verify) {
                var qr = new QRCode(document.getElementById("qrCode"), {
                    text: verify,
                    width: 200,
                    height: 200,
                });
            }

            // Llamada a la función para generar el código QR
            generarQR(verify); // Puedes cambiar "https://ejemplo.com" por la URL que desees codificar en el QR

            // Obtener la fecha actual
            var today = new Date();
            var dd = String(today.getDate()).padStart(2, "0");
            var mm = String(today.getMonth() + 1).padStart(2, "0"); // Enero es 0!
            var yyyy = today.getFullYear();

            today = dd + "/" + mm + "/" + yyyy;

            // Actualizar el contenido del elemento con id "date"
            $("#date").text(today);
            // Obtener la información del localStorage
            // Añadir un año a la fecha actual
            var nextYear = new Date(yyyy + 1, mm - 1, dd); // Restar 1 al mes ya que en JavaScript los meses van de 0 a 11
            var ddNextYear = String(nextYear.getDate()).padStart(2, "0");
            var mmNextYear = String(nextYear.getMonth() + 1).padStart(2, "0");
            var yyyyNextYear = nextYear.getFullYear();

            var fechaVencimiento =
                ddNextYear + "/" + mmNextYear + "/" + yyyyNextYear;

            $("#fechaVencimiento").text(fechaVencimiento);



            // const patente = datosVehiculo.patente;
            const rut = datosVehiculo.RUT;
            const razonSocial = datosVehiculo.Razon_Social;
            const lat = datosVehiculo.lat;
            const lng = datosVehiculo.long;
            const coord = lat + ',' + lng;
            const urlmap = './mapa.html';
            //$("#lpf").attr("href", urlmap, "_blank");
            $("#lpf").click(function () {
                window.open(urlmap, "_blank");
            });

            console.log(coord);


            // Recupera los datos de 'featuresSelected' de localStorage
            let featuresSelected = JSON.parse(localStorage.getItem('featuresSelected'));


            // Selecciona el contenedor de la lista
            let featuresList = $('#featuresListContainer');


            // Verificar si la información existe en el localStorage
            if (patente) {
                // Mostrar la información en el elemento con id "patente"
                $("#patente").text(patente);
                $("#verify").text(codigo);
                $("#imei").text(datosVehiculo.imei);
                $("#lpf").html(datosVehiculo.last_update);
                $("#rut").text(rut);
                $("#razon").text(razonSocial);

            }

            function generarClaveAleatoria(longitud) {
                var caracteres =
                    "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
                var clave = "";

                for (var i = 0; i < longitud; i++) {
                    var indice = Math.floor(Math.random() * caracteres.length);
                    clave += caracteres.charAt(indice);
                }

                return clave;
            }
        });

        function descargarPDF() {
            // Selecciona el contenido que deseas convertir en PDF
            const element = document.querySelector('.container');

            // Estilo temporal para ajustar el ancho al formato A4
          //  element.style.width = '18cm';

            // Opciones de PDF
            const opciones = {

                    // Márgenes en centímetros (ajusta según sea necesario)
                filename: 'documento.pdf', // Nombre del archivo PDF
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 1, width: 1000 },
                jsPDF: { unit: 'cm', format: 'a4', orientation: 'portrait' } // formato A4
            };

            // Genera y descarga el PDF
            html2pdf().set(opciones).from(element).save()
                .then(() => {
                    // Restablece el estilo original del ancho
                  //  element.style.width = '800px';
                });
        }
        function abrirModalCorreo() {

            $('#modalCorreo').modal('show');
        }
        $('#btnEnviarCorreo').click(function () {
            const email = $('#email').val();
            const contenidoDiv = document.querySelector('.margen').innerHTML;

            if (!email) {
                alert('Por favor, ingrese un correo electrónico.');
                return;
            }
            $('#modalCorreo').modal('hide');

            // Configurar las opciones para el PDF en tamaño A4
            const options = {
                // margin: [1, 2, 1, 2],        // Márgenes en centímetros (ajusta según sea necesario)
                filename: 'documento.pdf', // Nombre del archivo PDF
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 1, width: 1000 },
                jsPDF: { unit: 'cm', format: 'a4', orientation: 'portrait' } // formato A4
            };
            // Generar PDF y enviarlo al backend en base64
            html2pdf().set(options).from(contenidoDiv).toPdf().output('datauristring').then(function (pdfBase64) {
                $.ajax({
                    url: 'https://masgps-bi.wit.la/certificado-wit/server/send_mail.php',
                    type: 'POST',

                    data: { pdfBase64: pdfBase64, email: email },
                    success: function (response) {
                        alert('Correo enviado correctamente.');
                    },
                    error: function () {
                        alert('Hubo un error al enviar el correo.');
                    }
                });
            });



        });

    </script>
</body>

</html>